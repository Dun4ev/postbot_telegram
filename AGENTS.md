# Repository Guidelines

## Структура проекта и организация модулей
Основной код расположен в `bot.py`; он отвечает за запуск Telegram-бота и взаимодействие с API. Docker-оркестрация описана в `docker-compose.yml`, используйте её для локальной отладки без прямой установки брокеров. Локальные зависимости разворачивайте в `venv/` (не коммитим). При расширении функциональности придерживайтесь слоёв: `postbot/core` — бизнес-логика без I/O, `postbot/services` — интеграции (Telegram, хранилища), `postbot/ui` — CLI или будущий UI. Тесты сохраняйте в `tests/` с зеркальной структурой относительно `postbot/`.

## Команды сборки, запуска и разработки
Активируйте окружение и установите зависимости:
```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```
Запуск бота локально:
```bash
python bot.py
```
Запуск через Docker Compose (поднимает все сервисы):
```bash
docker-compose up --build
```
Проверка стиля и статического анализа:
```bash
ruff check .
black --check .
mypy .
```

## Стиль кодирования и соглашения
Код пишем на Python 3.11+, отступы 4 пробела. Имена модулей — `snake_case`, классов — `PascalCase`, переменных и функций — `snake_case`. Конфигурационные ключи в `.env` пишите заглавными буквами с префиксом `POSTBOT_`. Перед коммитом запускайте `ruff`, затем `black`, затем `mypy`; автоматически исправляемое форматирование выполняйте `black .`. Докстринги и комментарии — на русском.

## Тестирование
Используем `pytest`. Файлы тестов именуем `test_<module>.py`, классы `Test<ClassName>`, фикстуры — `fixture_<purpose>`. Минимальная покрытие — 80%; проверяйте:
```bash
pytest --cov=postbot --cov-report=term-missing
```
Добавляйте интеграционные тесты для внешних API с использованием заглушек и `pytest-mock`.

## Коммиты и pull request
Сообщения коммитов в стиле `<type>: <summary>` (пример: `fix: handle missing caption`). В summary ≤50 символов, в body описывайте мотивацию и риски. Для PR обязательны: ссылка на задачу, чек-лист прогонов `ruff`, `black --check`, `mypy`, `pytest -q`, описание изменений и скриншоты/логи при изменении поведения бота. Убедитесь, что секреты не попадают в репозиторий; проверяйте `.env.example` перед отправкой.

## Безопасность и конфигурация
Все токены и пароли задавайте через переменные окружения или секрет-менеджер. Валидацию входных данных проводите до отправки в Telegram API, экранируйте пользовательский ввод. При работе с базой применяйте параметризованные запросы или ORM. Не храните реальные вебхуки в истории — используйте плейсхолдеры вида `https://example.com/webhook`.

## Документация и версии

**Источник правды по агентам:** один файл `AGENTS.md`. Если в проекте встречается `GEMINI.md` — перенеси релевантное и удали файл-двойник (единый контекст снижает риски рассинхронизации).

**Когда менять документы и версию**

- Если меняется публичное поведение (API/CLI/конфиги/форматы/дефолты/коды ошибок):
  1) обнови `README.md` (примеры, параметры, конфиги),
  2) добавь запись в `CHANGELOG.md` по Keep a Changelog (категории: Added/Changed/Fixed/Deprecated/Removed; пометь BREAKING),
  3) бампни SemVer: MAJOR — несовместимое, MINOR — совместимая функциональность, PATCH — исправления.
- Если изменение **внутреннее** (рефактор/оптимизация) и не трогает публичный контракт — запись в `CHANGELOG.md` **не обязательна**.

**План работ**

- Долгосрочные задачи храним в `docs/ROADMAP.md` с метками: `todo` / `in-progress` / `blocked` / `done`.
